name: FEDS Bot Discord Tag
on:
  workflow_dispatch:
    inputs:
      question:
        required: true
        type: string
      channel_id:
        required: true
        type: string
      message_id:
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  answer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ask Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: "${{ github.event.inputs.question }}"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # show_full_output: true # Comment back in to see full output for debugging
          claude_args: |
            --tools Read,Glob,Grep,WebSearch,Bash
            --append-system-prompt "This request is coming through a Discord bot. Respond FAST (to not keep them waiting)! Be CONCISE  (responses will be truncated to 1900 characters)! Be DIRECT (this is a one-shot request, user can't reply)! Reply in format that displays well in Discord (eg no markdown)!"

      # Comment back in to see full output for debugging 
      # - name: Debug execution file
      #   run: cat "${{ steps.claude.outputs.execution_file }}"

      - name: Reply in Discord
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        run: |
          # Extract Claude's response from the execution file
          RESPONSE=$(jq -r '.[] | select(.type == "result") | .result' "${{ steps.claude.outputs.execution_file }}")

          # Truncate to Discord's limit and escape for JSON
          ESCAPED=$(echo "$RESPONSE" | head -c 1900 | jq -Rs .)

          # Send to Discord
          curl -X POST \
            "https://discord.com/api/v10/channels/${{ github.event.inputs.channel_id }}/messages" \
            -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"content\": $ESCAPED, \"message_reference\": {\"message_id\": \"${{ github.event.inputs.message_id }}\"}}"
