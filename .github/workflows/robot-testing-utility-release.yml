# =============================================================================
# robot-testing-utility Release
# =============================================================================
#
# Triggered when a tag matching rtu/v* is pushed (e.g., rtu/v1.0.0).
#
# Steps:
#   1. Build and test the library
#   2. Create a GitHub Release named after the tag
#   3. Upload robot-testing-utility-<version>.jar as a release asset
#
# Tag format:  rtu/v<semver>   (e.g. rtu/v1.0.0, rtu/v1.2.3-beta)
# =============================================================================

name: robot-testing-utility Release

on:
  push:
    tags:
      - 'rtu/v*'

jobs:
  release:
    name: Build, Publish & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write    # create GitHub Releases and upload assets
      packages: write    # publish to GitHub Packages Maven

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Grant execute permission for gradlew
        working-directory: robot/robot-testing-utility
        run: chmod +x gradlew

      - name: Extract version from tag
        id: version
        # Tag is like rtu/v1.0.0 — strip the rtu/v prefix
        run: echo "version=${GITHUB_REF_NAME#rtu/v}" >> "$GITHUB_OUTPUT"

      - name: Build and test
        working-directory: robot/robot-testing-utility
        run: ./gradlew build -Pgpr.version=${{ steps.version.outputs.version }}

      - name: Publish to GitHub Packages
        working-directory: robot/robot-testing-utility
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: ./gradlew publish -Pgpr.version=${{ steps.version.outputs.version }}

      - name: Find JAR artifact
        id: jar
        working-directory: robot/robot-testing-utility
        run: |
          jar_path=$(ls build/libs/robot-testing-utility-*.jar | grep -v sources | grep -v javadoc | head -1)
          echo "path=$jar_path" >> "$GITHUB_OUTPUT"
          echo "name=$(basename $jar_path)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release and upload JAR
        uses: softprops/action-gh-release@v2
        with:
          name: "robot-testing-utility v${{ steps.version.outputs.version }}"
          tag_name: ${{ github.ref_name }}
          body: |
            ## robot-testing-utility v${{ steps.version.outputs.version }}

            Standalone FRC robot test harness — auto-discovers and runs `@RobotAction` methods on your subsystems in Test mode.

            ### Installing via GitHub Packages Maven (recommended)

            **`build.gradle`** — add the repository and dependency:
            ```groovy
            repositories {
                maven {
                    name = 'GitHubPackages'
                    url  = uri('https://maven.pkg.github.com/feds201/feds-central')
                    credentials {
                        username = project.findProperty('gpr.user') ?: System.getenv('GITHUB_ACTOR')
                        password = project.findProperty('gpr.key')  ?: System.getenv('GITHUB_TOKEN')
                    }
                }
            }

            dependencies {
                implementation 'frc.rtu:robot-testing-utility:${{ steps.version.outputs.version }}'
            }
            ```

            Add your GitHub credentials to `~/.gradle/gradle.properties`:
            ```
            gpr.user=YOUR_GITHUB_USERNAME
            gpr.key=YOUR_GITHUB_PAT
            ```
            > **Note:** Your PAT needs `read:packages` scope. Generate one at GitHub → Settings → Developer settings → Personal access tokens.

            ### Or download the JAR below
            Drop it in `libs/` and add `implementation fileTree(dir: 'libs', include: ['*.jar'])`.

            See the [README](https://github.com/${{ github.repository }}/blob/main/robot/robot-testing-utility/README.md) and [Operations Manual](https://github.com/${{ github.repository }}/blob/main/operations-manual/content/Home/Programming/FRC/RobotTestingUtility.mdx) for full documentation.
          files: robot/robot-testing-utility/${{ steps.jar.outputs.path }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
